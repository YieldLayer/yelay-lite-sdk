name: Publish SDK npm package

on:
    push:
        tags:
            - 'v[0-9]+.[0-9]+.[0-9]+-?[a-zA-Z0-9]*'

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - name: Get the version
              id: get_version
              run: echo "VERSION=${GITHUB_REF/refs\/tags\//}" >> $GITHUB_OUTPUT

            - name: Get Tag
              id: tag
              env:
                  IMAGE_TAG: ${{ steps.get_version.outputs.VERSION }}
              run: if [[ $IMAGE_TAG == *'dev'* ]]; then echo "TAG=dev" >> $GITHUB_OUTPUT; else echo "TAG=latest" >> $GITHUB_OUTPUT; fi

            - name: Replace version string
              id: replaced_version
              env:
                  IMAGE_TAG: ${{ steps.get_version.outputs.VERSION }}
              run: |
                  string=$IMAGE_TAG
                  replaced=${string/v/}
                  echo "VERSION=$replaced" >> $GITHUB_OUTPUT

            - name: Replace version inside package.json
              env:
                  VERSION: ${{ steps.replaced_version.outputs.VERSION }}
              run: bash ./deployment-scripts/versioner.sh $VERSION

            - uses: actions/setup-node@v3
              with:
                  node-version: 18

            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 8
                  run_install: false

            - name: Verify lockfile exists
              run: |
                  if [ ! -f "pnpm-lock.yaml" ]; then
                      echo "ERROR: pnpm-lock.yaml not found!"
                      ls -la
                      exit 1
                  fi
                  echo "âœ… pnpm-lock.yaml found"

            - run: pnpm install -g @microsoft/api-extractor
            - name: Clear pnpm cache and install
              run: |
                  pnpm store prune
                  pnpm install --frozen-lockfile
            - run: pnpm run build

            - uses: JS-DevTools/npm-publish@v1
              with:
                  tag: ${{ steps.tag.outputs.TAG }}
                  token: ${{ secrets.NPM_KEY }}
                  access: public
